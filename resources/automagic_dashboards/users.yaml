bindings:
  fields:
  - named:
    - [created, 1.0]
    - [timestamp, 0.9]
    - [date, 0.8]
    - [registered, 1.0]
    - [registration, 1.0]
    type: DateTime
    as: timestamp
    table: ?users
  - named:
    - [created, 1.0]
    - [timestamp, 1.0]
    - [date, 0.8]
    type: DateTime
    as: order_date
    table: ?orders
  - named: state
    as: state
    type:
    - [Text, 0.8]
    - [State, 1.0]
    table: ?users
  - named: country
    as: country
    type:
    - [Text, 0.8]
    - [Country, 1.0]
    table: ?users
  - named:
    - [channel, 1.0]
    - [source, 1.0]
    type:
    - [Category, 1.0]
    - [Text, 0.9]
    as: source
    table: ?users
  - named:
    - [user, 1.0]
    - [account, 1.0]
    - [customer, 1.0]
    type: FK
    as: users_fk
    table: ?orders
  - named: id
    type:
    - [PK, 1.0]
    - [Integer, 0.4]
    table: ?users
    as: users_id
  - named:
    - [total, 1.0]
    - [amount, 0.9]
    - [income, 1.0]
    - [price, 0.6]
    type: Number
    as: income
    table: ?orders
  tables:
  - named:
    - [user, 1.0]
    - [people, 8.0]
    - [account, 1.0]
    - [customer, 1.0]
    - [profile, 1.0]
    as: users
  - named:
    - [order, 1.0]
    - [transaction, 1.0]
    - [sale, 1.0]
    - [booking, 1.0]
    as: orders
cards:
- dashboard: "?users_dashboard"
  visualization: line
  title: New users by month
  description: How many new users have we acquired each month
  query:
    source_table: "?users"
    breakout: [datetime-field, "?timestamp", month]
    aggregation: [count]
- title: LTV
  as: ltv
  query: select sum(?income) as LTV, ?source as SOURCE
         from ?orders left join ?users on ?users_fk = ?users_id
         group by ?users_id
- title: First year orders
  as: first_year_orders
  query: select count(*) as NUM_ORDERS, ?timestamp as COHORT
         from ?orders left join ?users on ?users_fk = ?users_id
         where datediff("MONTH", ?timestamp, ?order_date) <= 12
         group by ?users_id
- dashboard: "?users_dashboard"
  visualization: bar
  title: Orders by cohort
  description: Average number of orders in the first year by cohort
  query:
    source_table: "?first_year_orders"
    breakout: [datetime-field, [field-id, [field-literal, COHORT, type/DateTime]], month]
    aggregation: [avg, [field-id, [field-literal, NUM_ORDERS, type/Integer]]]
- dashboard: "?users_dashboard"
  visualization: [map, {map.type: region,
                        map.region: us_states}]
  title: Users by state
  query:
    source_table: ?users
    breakout: ["?state"]
    aggregation: [count]
- dashboard: "?users_dashboard"
  visualization: [map, {map.type: region,
                        map.region: world}]
  title: Users by country
  query:
    source_table: ?users
    breakout: ["?country"]
    aggregation: [count]
- dashboard: "?users_dashboard"
  title: Users by source
  query:
    source_table: ?users
    breakout: ["?source"]
    aggregation: [count]
    order_by: [[[aggregation, 0], "descending"]]
  visualization: row
- dashboard: "?users_dashboard"
  title: LTV by source
  description: Average total value of ordereds per user by source
  query:
    source_table: ?ltv
    breakout: ["?source"]
    aggregation: [avg, [field-id, [field-literal, LTV, type/Number]]]
    order_by: [[[aggregation, 0], "descending"]]
  visualization: row
dashboards:
- title: Users autogenerated
  as: users_dashboard
  description: Autogenerated dashboard
