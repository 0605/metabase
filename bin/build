#! /usr/bin/perl

use strict;
use warnings;

use Env qw($CI);

sub version {
    return if $CI;

    my ($tag, $hash, $branch, $date) = split ' ', (`./bin/version` or die $!);

    open my $file, '>resources/version.properties' or die $!;
    print $file ("tag=$tag\n" .
                 "hash=$hash\n" .
                 "branch=$branch\n" .
                 "date=$date\n");
    close $file;
}

sub frontend {
    system('npm', 'install') == 0 or die $!;
    system('./node_modules/webpack/bin/webpack.js', '-p') == 0 or die $!;
}

sub sample_dataset {
    (system('lein', 'generate-sample-dataset') or die $!) unless -f 'resources/sample-dataset.db.mv.db';
}

sub uberjar {
    system 'lein', 'uberjar' or die $!;
}

@ARGV = ('version', 'frontend', 'sample_dataset', 'uberjar') unless @ARGV;
map { eval $_ } @ARGV;
