#!/usr/bin/env node

var jwt = require("jsonwebtoken");

var BASE_URL = "http://localhost:3000";
var METABASE_EMBED_SECRET_KEY = process.env["MB_EMBEDDING_SECRET_KEY"];

var resourceType = process.argv[2];
var resourceId = parseFloat(process.argv[3]);

var resourceTypes = {
  "card": "question",
  "dashboard": "dashboard",
}

if (!METABASE_EMBED_SECRET_KEY || !resourceTypes[resourceType] || typeof resourceId !== "number" || isNaN(resourceId)) {
  process.stderr.write("USAGE: MB_EMBEDDING_SECRET_KEY=ABCD embed-sign <resource_type> <resource_id>\n");
  process.exit(1);
}

var resource = {};
resource[resourceType] = resourceId;

var unsignedToken = {
  resource: resource,
  params: {}
};

var signedToken = jwt.sign(unsignedToken, METABASE_EMBED_SECRET_KEY);

console.log(BASE_URL + "/embed/" + resourceTypes[resourceType] + "/" + signedToken);
